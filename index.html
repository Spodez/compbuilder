<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spades' Comp Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            background-color: #1a202c;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
        }

        #comp-container {
            transition: background-image 0.3s ease-in-out;
        }

        /* --- Item Slot Styles --- */
        .item-slot {
            width: 56px; /* --- MOBILE/TOUCH FIX: Smaller base size for mobile --- */
            height: 56px;
            background-color: #2d3748;
            border: 2px dashed #4a5568;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            overflow: hidden;
            position: relative;
            flex-shrink: 0; /* --- MOBILE/TOUCH FIX: Prevent shrinking in flex container --- */
        }

        @media (min-width: 640px) { /* sm breakpoint */
            .item-slot {
                width: 64px; /* --- MOBILE/TOUCH FIX: Restore original size on larger screens --- */
                height: 64px;
            }
        }

        .item-slot:hover {
            background-color: #4a5568;
        }

        .item-slot .primary-item-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 0.375rem;
            z-index: 1;
        }

        /* --- Ability Text Overlay --- */
        .ability-text-overlay {
            position: absolute; top: 0; left: 0; width: 100%;
            background-color: rgba(0, 0, 0, 0.7); color: #4ade80; font-size: 0.7rem; font-weight: bold;
            text-align: center; padding: 1px 0; z-index: 3; pointer-events: none;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.1;
        }
        .ability-text-overlay:empty { display: none; }

        /* --- Alternative Item Overlay --- */
        .alternative-item-overlay {
            position: absolute; bottom: -1px; right: -1px; width: 45%; height: 45%;
            background-color: rgba(45, 55, 72, 0.8); border: 1px solid #4a5568; border-radius: 0.25rem;
            display: flex; align-items: center; justify-content: center; z-index: 4; transition: opacity 0.2s; opacity: 0;
        }

        .alternative-item-overlay img { width: 100%; height: 100%; object-fit: contain; border-radius: 0.125rem; }
        .alternative-item-overlay:has(img) { opacity: 1; }
        .item-slot:not(:has(.primary-item-img)) .alternative-item-overlay { display: none; }

        @media (hover: hover) {
            .item-slot:hover .alternative-item-overlay { opacity: 1; }
            .item-slot:not(:hover) .alternative-item-overlay:not(:has(img)) { opacity: 0; }
        }

        /* Quantity display on items */
        .item-quantity {
            position: absolute; bottom: 2px; left: 2px; background-color: rgba(0, 0, 0, 0.7); color: white;
            font-size: 0.75rem; font-weight: bold; padding: 1px 4px; border-radius: 0.375rem;
            min-width: 1.5rem; text-align: center; z-index: 2; display: none;
        }
        .item-slot[data-quantity]:not([data-quantity="1"]) .item-quantity { display: block; }
        .item-slot .quantity-input {
            position: absolute; top: 2px; right: 2px; width: 30px; height: 20px;
            background-color: rgba(0, 0, 0, 0.7); color: white; border: none; border-radius: 4px;
            text-align: center; font-size: 0.75rem; padding: 0; z-index: 5; display: none;
        }

        @media (hover: hover) {
            .item-slot:hover .quantity-input { display: block; }
            .item-slot:hover .item-quantity { display: none; }
        }

        /* --- Build Party Quantity Input --- */
        .build-quantity-container { width: 50px; display: flex; justify-content: center; align-items: center; }
        .build-quantity-input {
            width: 40px; background-color: #4a5568; border: 1px solid #718096; border-radius: 0.375rem;
            color: white; text-align: center; font-size: 0.875rem; padding: 2px; touch-action: manipulation;
        }
        .build-quantity-display { display: none; font-weight: bold; font-size: 1.25rem; color: #e2e8f0; width: 40px; text-align: center; margin-right: 0.5rem; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); }

        /* --- Custom Context Menu --- */
        #item-context-menu { position: fixed; z-index: 1000; width: 200px; background-color: #2d3748; border: 1px solid #4a5568; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        #item-context-menu button { display: block; width: 100%; text-align: left; padding: 0.75rem 1rem; color: #e2e8f0; font-size: 0.875rem; touch-action: manipulation; }
        #item-context-menu button:hover { background-color: #4a5568; }
        #item-context-menu button.danger { color: #f87171; }
        #item-context-menu hr { border-color: #4a5568; margin: 0.25rem 0; }

        /* --- Modals and Scrollbar --- */
        .modal-wrapper { position: fixed; inset: 0; z-index: 50; display: flex; align-items: center; justify-content: center; background-color: rgba(0, 0, 0, 0.8); }
        .modal-content { background-color: #2d3748; max-height: 80vh; margin: auto; border-radius: 0.5rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        .modal-input { width: 100%; padding: 0.5rem; background-color: #4a5568; border-radius: 0.375rem; border: 1px solid #718096; color: white; }
        .modal-input:focus { outline: none; border-color: #63b3ed; box-shadow: 0 0 0 2px rgba(99, 179, 237, 0.5); }

        /* --- Drag Handle & Toast --- */
        .build-drag-handle { cursor: grab; padding: 0 8px; color: #718096; font-size: 1.25rem; line-height: 1; touch-action: none; }
        .build-drag-handle:active { cursor: grabbing; }
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #38a169; color: white; padding: 10px 20px; border-radius: 8px; opacity: 0; transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; z-index: 100; }
        #toast.show { opacity: 1; transform: translate(-50%, -10px); }

        /* --- Layout Styles --- */
        #roles-container { display: flex; flex-wrap: wrap; gap: 1.5rem; justify-content: center; margin-top: 1rem; }
        .role-section {
            display: flex; flex-direction: column; align-items: stretch; padding: 1rem;
            border-radius: 0.5rem; min-width: 200px; border: 1px solid rgba(45, 55, 72, 0.5);
            background-color: #2d3748; transition: box-shadow 0.2s, transform 0.2s;
        }
        .role-section.dragging { opacity: 0.5; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3); transform: scale(1.02); }
        .role-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem; flex-shrink: 0; }
        .role-title { font-size: 1.5rem; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); white-space: nowrap; }
        .role-collapse-toggle { background: none; border: none; color: #9ca3af; font-size: 1rem; cursor: pointer; transition: transform 0.2s; padding: 0.25rem; touch-action: manipulation; }
        .role-section.collapsed .role-collapse-toggle { transform: rotate(-90deg); }
        .role-drag-handle { cursor: move; color: #718096; font-size: 1.25rem; padding-left: 0.25rem; padding-right: 0.5rem; touch-action: none; }

        .builds-container { display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.25rem; transition: all 0.3s ease-out; overflow: hidden; }
        .role-section.collapsed .builds-container { display: none; }

        .build-row { display: flex; align-items: center; gap: 2px; }
        .build-items-wrapper {
            display: flex; gap: 2px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: thin;
        }
        .category-label { position: absolute; top: -1.5rem; left: 0; width: 100%; text-align: center; font-size: 0.75rem; color: #94a3b8; white-space: nowrap; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); }
        .builds-container .build-row:first-child .item-slot-wrapper { margin-top: 1.5rem; position: relative; }
        .builds-container .build-row:first-child .item-slot-wrapper[data-category="weapons"] .category-label::before { content: "Weapon"; }
        .builds-container .build-row:first-child .item-slot-wrapper[data-category="OffHands"] .category-label::before { content: "Off-Hand"; }
        .builds-container .build-row:first-child .item-slot-wrapper[data-category="Head"] .category-label::before { content: "Head"; }
        .builds-container .build-row:first-child .item-slot-wrapper[data-category="Chest"] .category-label::before { content: "Chest"; }
        .builds-container .build-row:first-child .item-slot-wrapper[data-category="Shoes"] .category-label::before { content: "Shoes"; }
        .builds-container .build-row:first-child .item-slot-wrapper[data-category="Capes"] .category-label::before { content: "Cape"; }
        .builds-container .build-row:first-child .item-slot-wrapper[data-category="Food"] .category-label::before { content: "Food"; }
        .builds-container .build-row:first-child .item-slot-wrapper[data-category="Potion"] .category-label::before { content: "Potion"; }

        /* --- Tab Controls --- */
        .tab-buttons { display: flex; border-bottom: 2px solid #4a5568; margin-bottom: 1rem; overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none;}
        .tab-buttons::-webkit-scrollbar { display: none; }
        .tab-btn { padding: 0.75rem 1rem; background-color: transparent; border: none; color: #9ca3af; font-size: 1rem; font-weight: 600; cursor: pointer; transition: color 0.2s, border-bottom-color 0.2s; border-bottom: 3px solid transparent; margin-bottom: -2px; white-space: nowrap; touch-action: manipulation; }
        @media(min-width: 640px) { .tab-btn { padding: 0.75rem 1.5rem; } }
        .tab-btn.active { color: #3b82f6; border-bottom-color: #3b82f6; }
        .tab-btn:hover:not(.active) { color: #e2e8f0; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* --- Style Controls --- */
        .control-section { background-color: #2d3748; border: 1px solid #4a5568; border-radius: 0.5rem; padding: 0.75rem; }
        .style-control-group { display: flex; align-items: center; gap: 0.5rem; }
        .style-control-group label { font-size: 0.875rem; color: #9ca3af; white-space: nowrap; }
        .style-control-group input[type="range"] { width: 100px; touch-action: manipulation; }
        .style-control-group input[type="color"] { background-color: transparent; border: none; width: 32px; height: 32px; cursor: pointer; border-radius: 0.25rem; padding: 0; }
        .style-control-group input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        .style-control-group input[type="color"]::-webkit-color-swatch { border: 1px solid #4a5568; border-radius: 0.25rem; }
        .style-control-group .select-input { background-color: #4a5568; border: 1px solid #718096; border-radius: 0.375rem; color: white; padding: 4px 8px; font-size: 0.875rem; touch-action: manipulation; }
        .align-btn-group button { background-color: #4a5568; padding: 4px 10px; font-size: 0.875rem; border: 1px solid #718096; color: #cbd5e0; transition: background-color 0.2s; touch-action: manipulation; }
        .align-btn-group button:first-child { border-top-left-radius: 0.375rem; border-bottom-left-radius: 0.375rem; }
        .align-btn-group button:last-child { border-top-right-radius: 0.375rem; border-bottom-right-radius: 0.375rem; }
        .align-btn-group button.active { background-color: #3b82f6; color: white; font-weight: bold; }
        .align-btn-group button:hover:not(.active) { background-color: #5a6578; }

        /* --- Party Table Styles --- */
        #party-table-editor { border-collapse: collapse; table-layout: auto; }
        #party-table-editor th, #party-table-editor td { padding: 0.5rem 0.75rem; border: 1px solid #4a5568; text-align: center; }
        #party-table-editor th { background-color: #374151; font-weight: 600; font-size: 0.875rem; }
        #party-table-editor td input[type="number"] { width: 4rem; background-color: #4a5568; color: white; border: 1px solid #718096; border-radius: 0.25rem; text-align: center; padding: 0.25rem; touch-action: manipulation; }
        #party-table-editor td input[type="number"]::-webkit-inner-spin-button, 
        #party-table-editor td input[type="number"]::-webkit-outer-spin-button { margin: 0; appearance: none; }
        #party-table-editor td:first-child { font-weight: bold; background-color: #374151; }
        
        #party-table-clone { border-collapse: collapse; margin-bottom: 1rem; background-color: rgba(45, 55, 72, 0.8); color: white; transform-origin: top left; }
        #party-table-clone th, #party-table-clone td { padding: 0.5rem 1rem; border: 1px solid #718096; text-align: center; }
        #party-table-clone th { background-color: rgba(26, 32, 44, 0.7); font-size: 0.875rem; }
        #party-table-clone td:first-child { font-weight: bold; }

        /* --- FULL EXPORT MODE STYLES --- */
        #temp-export-wrapper { padding: 1rem; width: fit-content; margin: auto; background-size: cover; background-position: center; }
        @media(min-width: 640px) { #temp-export-wrapper { padding: 1.5rem; } }

        .export-mode .build-drag-handle, .export-mode .remove-build-btn, .export-mode .copy-build-btn, .export-mode .add-build-btn, 
        .export-mode .paste-build-btn, .export-mode #export-btn, .export-mode .category-label, .export-mode .item-slot .quantity-input, 
        .export-mode .role-section .role-header .flex, .export-mode #header-controls, .export-mode #action-buttons, 
        .export-mode .save-build-btn, .export-mode .build-quantity-input, .export-mode .role-collapse-toggle, 
        .export-mode .role-drag-handle, .export-mode .export-single-build-btn { display: none !important; } /* --- ADDITION: Added .export-single-build-btn --- */
        
        .export-mode, .export-mode .role-section, .export-mode .build-row, .export-mode .item-slot { background-color: transparent !important; border-color: transparent !important; box-shadow: none !important; }
        .export-mode .role-header { justify-content: center; } /* Center role title on export */
        .export-mode .build-quantity-display { display: block; }
        .export-mode .build-quantity-display:empty { display: none; }
        .export-mode .builds-container, .export-mode .build-items-wrapper { gap: 0px !important; display: flex !important; overflow-x: visible !important; }
        .export-mode .item-slot { padding: 1px; border-radius: 0 !important; cursor: default !important; overflow: visible; }
        .export-mode #comp-title-clone { font-weight: bold; margin-bottom: 1rem; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7); }
        .export-mode #comp-notes-clone { white-space: pre-wrap; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7); }
        .export-mode #temp-export-wrapper > #comp-notes-clone, .export-mode #temp-export-wrapper > #party-table-clone { margin-bottom: 1rem; max-width: 800px; margin-left: auto; margin-right: auto; }
        .export-mode .export-column-1 > #comp-notes-clone, .export-mode .export-column-2 > #comp-notes-clone,
        .export-mode .export-column-1 > #party-table-clone, .export-mode .export-column-2 > #party-table-clone { margin-bottom: 1rem; }
        .export-mode #logo-image-clone { max-width: 300px; height: auto; display: block; margin: 0 auto 1.5rem auto; }
        .export-mode .export-roles-main-wrapper { display: flex; flex-direction: column; gap: 1.5rem; } 
        @media (min-width: 768px) { .export-mode .export-roles-main-wrapper { flex-direction: row; justify-content: space-between; gap: 2rem; align-items: flex-start; } }
        .export-mode .export-column-1, .export-mode .export-column-2 { display: flex; flex-direction: column; gap: 1.5rem; flex-basis: 100%; background-color: rgba(26, 32, 44, 0.5); border-radius: 0.5rem; padding: 0.5rem; }
        @media (min-width: 768px) { .export-mode .export-column-1, .export-mode .export-column-2 { flex-basis: 50%; } }
        .export-mode .alternative-item-overlay { border: 1px solid #718096; }
        .export-mode .ability-text-overlay { color: #4ade80; font-size: 0.7rem; white-space: normal; overflow: visible; text-overflow: clip; line-height: 1.2; }
        .export-mode .ability-text-overlay:empty { display: none; }

        /* --- START: ADDED FOR SINGLE BUILD EXPORT --- */
        #single-build-export-wrapper {
            position: absolute;
            left: -9999px; /* Position off-screen to hide from view */
            padding: 1rem;
            background-color: #1a202c; /* Consistent background color for capture */
            display: inline-block; /* Ensure wrapper fits content */
        }
        #single-build-export-wrapper .build-row {
            background-color: #2d3748; /* Add a card background to the exported build row */
            border-radius: 0.5rem;
            padding: 0.75rem;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        #single-build-export-wrapper .build-drag-handle,
        #single-build-export-wrapper .save-build-btn,
        #single-build-export-wrapper .copy-build-btn,
        #single-build-export-wrapper .remove-build-btn,
        #single-build-export-wrapper .export-single-build-btn,
        #single-build-export-wrapper .build-quantity-input,
        #single-build-export-wrapper .category-label {
            display: none !important;
        }
        #single-build-export-wrapper .build-quantity-display {
            display: block; /* Show static quantity text */
            color: #e2e8f0;
            font-weight: bold;
            font-size: 1.25rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        #single-build-export-wrapper .item-slot {
             background-color: transparent !important;
             border-color: transparent !important;
             box-shadow: none !important;
        }
        #single-build-export-wrapper .build-items-wrapper {
            overflow-x: visible !important; /* Ensure no scrollbar appears in screenshot */
        }
        /* --- END: ADDED FOR SINGLE BUILD EXPORT --- */
    </style>
</head>

<body class="p-2 sm:p-4 md:p-8">

    <div id="comp-container" class="w-full max-w-7xl mx-auto bg-gray-900 p-3 sm:p-6 rounded-lg shadow-xl">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
            <div id="header-controls" class="w-full flex-grow md:mr-8 mb-4 md:mb-0">
                <div class="tab-buttons">
                    <button class="tab-btn active" data-tab="tab-pane-content">Content</button>
                    <button class="tab-btn" data-tab="tab-pane-appearance">Appearance & Layout</button>
                </div>

                <div class="tab-content-container space-y-6">
                    <div id="tab-pane-content" class="tab-pane active space-y-6">
                        <div>
                            <label for="comp-title" class="text-lg sm:text-xl font-semibold mb-2 text-gray-300 block">Composition Title</label>
                            <input type="text" id="comp-title" placeholder="Untitled Composition" class="w-full bg-gray-800 text-white text-3xl sm:text-4xl font-bold p-2 rounded border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" style="text-align: center;">
                        </div>
                        <div>
                            <label for="comp-notes" class="text-lg sm:text-xl font-semibold mb-2 text-gray-300 block">Notes</label>
                            <textarea id="comp-notes" placeholder="Add additional notes here..." class="w-full bg-gray-800 text-gray-300 p-2 rounded border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 h-24 resize-none"></textarea>
                        </div>
                    </div>

                    <div id="tab-pane-appearance" class="tab-pane space-y-4">
                        <div class="control-section flex flex-wrap items-center justify-around gap-6">
                            <div id="logo-upload-section" class="flex flex-col items-center gap-2">
                                <img id="logo-preview" src="" alt="Comp Logo" class="hidden max-h-24 object-contain mb-2">
                                <input type="file" id="comp-logo-upload" class="hidden" accept="image/*">
                                <button id="upload-logo-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded text-sm w-full">Upload Logo</button>
                                <button id="remove-logo-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-sm hidden w-full">Remove Logo</button>
                            </div>
                            <div id="background-controls" class="flex flex-col items-center gap-2">
                                <span class="text-gray-400 text-sm mb-2">Custom Background</span>
                                <input type="file" id="background-upload-input" class="hidden" accept="image/*">
                                <button id="upload-background-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded text-sm w-full">Set Background</button>
                                <button id="remove-background-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-sm hidden w-full">Remove BG</button>
                            </div>
                        </div>
                        
                        <div id="style-controls-container" class="control-section space-y-3">
                            <div class="flex flex-wrap justify-center items-center gap-x-6 gap-y-2">
                                <span class="font-semibold text-gray-300 text-sm hidden sm:inline">Title:</span>
                                <div class="style-control-group align-btn-group" id="title-align-group">
                                    <button data-align="left" class="align-btn" title="Align Left">L</button>
                                    <button data-align="center" class="align-btn active" title="Align Center">C</button>
                                    <button data-align="right" class="align-btn" title="Align Right">R</button>
                                </div>
                                <div class="style-control-group">
                                    <label for="title-font-size">Size:</label>
                                    <input type="range" id="title-font-size" min="24" max="72" value="36" class="style-control-input">
                                    <span id="title-font-size-value" class="text-xs w-6 text-right">36px</span>
                                </div>
                                <div class="style-control-group">
                                    <label for="title-font-color">Color:</label>
                                    <input type="color" id="title-font-color" value="#E2E8F0" class="style-control-input">
                                </div>
                            </div>
                            <div class="flex flex-wrap justify-center items-center gap-x-6 gap-y-2 pt-3 border-t border-gray-700">
                                <span class="font-semibold text-gray-300 text-sm hidden sm:inline">Notes:</span>
                                <div class="style-control-group align-btn-group" id="notes-align-group">
                                    <button data-align="left" class="align-btn active" title="Align Left">L</button>
                                    <button data-align="center" class="align-btn" title="Align Center">C</button>
                                    <button data-align="right" class="align-btn" title="Align Right">R</button>
                                </div>
                                <div class="style-control-group">
                                    <label for="notes-font-size">Size:</label>
                                    <input type="range" id="notes-font-size" min="12" max="32" value="16" class="style-control-input">
                                    <span id="notes-font-size-value" class="text-xs w-6 text-right">16px</span>
                                </div>
                                <div class="style-control-group">
                                    <label for="notes-font-color">Color:</label>
                                    <input type="color" id="notes-font-color" value="#CBD5E0" class="style-control-input">
                                </div>
                                <div class="style-control-group">
                                    <label for="notes-position-select">Position:</label>
                                    <select id="notes-position-select" class="select-input">
                                        <option value="above_full">Above Roles (Full Width)</option>
                                        <option value="below_full">Below Roles (Full Width)</option>
                                        <option value="col1_top">Top of Column 1</option>
                                        <option value="col2_top">Top of Column 2</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="control-section space-y-3">
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="enable-party-table" class="rounded border-gray-500">
                                <label for="enable-party-table" class="font-semibold text-base sm:text-lg text-gray-200">Party Composition Table</label>
                            </div>
                            <div id="party-table-controls" class="hidden space-y-4 pt-2">
                                <div class="flex flex-wrap items-center gap-x-6 gap-y-2">
                                    <div class="style-control-group">
                                        <label for="party-table-position-select">Position:</label>
                                        <select id="party-table-position-select" class="select-input">
                                            <option value="above_full">Above Roles (Full Width)</option>
                                            <option value="below_full">Below Roles (Full Width)</option>
                                            <option value="col1_top">Top of Column 1</option>
                                            <option value="col2_top">Top of Column 2</option>
                                        </select>
                                    </div>
                                    <div class="style-control-group">
                                        <label for="party-table-scale">Scale:</label>
                                        <input type="range" id="party-table-scale" min="0.5" max="1.5" step="0.1" value="1">
                                        <span id="party-table-scale-value" class="text-xs w-10 text-right">100%</span>
                                    </div>
                                </div>
                                <div class="overflow-x-auto">
                                    <table id="party-table-editor">
                                        <thead>
                                            <tr>
                                                <th>Party size</th> <th>Engages</th> <th>Tanks</th> <th>Supports</th> <th>Healers</th> <th>DPS</th>
                                            </tr>
                                        </thead>
                                        <tbody id="party-table-body"></tbody>
                                    </table>
                                </div>
                                <button id="add-party-row-btn" class="bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold py-1 px-2 rounded mt-1">+ Add Row</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="action-buttons" class="flex flex-col space-y-2 w-full md:w-auto self-stretch md:self-start md:mt-16">
                <button id="save-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">Save Composition</button>
                <button id="load-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">Load Composition</button>
                <input type="file" id="load-file-input" class="hidden" accept=".json">
                <button id="export-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">Export to PNG</button>
            </div>
        </div>
        <div id="roles-container"></div>
    </div>

    <div id="item-modal" class="modal-wrapper hidden">
        <div class="modal-content w-11/12 max-w-4xl p-4 sm:p-6 relative overflow-y-auto">
            <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 mb-4">
                <h2 class="text-xl sm:text-2xl font-bold whitespace-nowrap">Select Item</h2>
                <span id="modal-category-tag" class="text-sm sm:text-base font-semibold text-blue-300 bg-blue-800/50 px-3 py-1 rounded-full"></span>
            </div>
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-2 sm:gap-4">
                <input type="text" id="item-search" placeholder="Search from predefined list..." class="modal-input flex-grow w-full sm:w-auto">
                <button id="upload-custom-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded whitespace-nowrap w-full sm:w-auto">Upload File</button>
                <input type="file" id="custom-image-upload" class="hidden" accept="image/*">
            </div>
            <div id="modal-grid" class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 gap-2 sm:gap-4"></div>
            <button id="close-modal" class="absolute top-2 right-2 sm:top-4 sm:right-4 text-gray-400 hover:text-white text-4xl leading-none">&times;</button>
        </div>
    </div>

    <div id="ability-modal" class="modal-wrapper hidden">
        <div class="modal-content w-11/12 max-w-sm p-6 relative">
            <h2 class="text-xl font-bold mb-4">Edit Abilities</h2>
            <p class="text-sm text-gray-400 mb-2">Enter ability codes (e.g., Q1 W2 E1)</p>
            <input type="text" id="ability-input" class="modal-input">
            <div class="mt-4 flex justify-end gap-2">
                <button id="ability-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">Cancel</button>
                <button id="ability-save-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded">Save</button>
            </div>
        </div>
    </div>

    <div id="save-build-modal" class="modal-wrapper hidden">
        <div class="modal-content w-11/12 max-w-lg p-6 relative">
            <h2 class="text-xl font-bold mb-4">Save Build to Library</h2>
            <div class="space-y-4">
                <div><label for="save-build-name" class="block text-sm font-medium text-gray-300 mb-1">Build Name</label><input type="text" id="save-build-name" class="modal-input" placeholder="e.g., Main Tank Build"></div>
                <div><label for="save-build-category-select" class="block text-sm font-medium text-gray-300 mb-1">Select Existing Category</label><select id="save-build-category-select" class="modal-input"></select></div>
                <div><label for="save-build-new-category" class="block text-sm font-medium text-gray-300 mb-1">Or Create New Category</label><input type="text" id="save-build-new-category" class="modal-input" placeholder="e.g., Tank Presets"></div>
            </div>
            <div class="mt-6 flex justify-end gap-2">
                <button id="save-build-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">Cancel</button>
                <button id="save-build-confirm-btn" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded">Save Build</button>
            </div>
        </div>
    </div>

    <div id="load-build-modal" class="modal-wrapper hidden">
        <div class="modal-content w-11/12 max-w-3xl p-6 relative">
            <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">Load Build from Library</h2><button id="load-build-close-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button></div>
            <div id="load-build-library-content" class="overflow-y-auto max-h-[60vh]"></div>
        </div>
    </div>

    <div id="item-context-menu" class="hidden">
        <button data-action="edit-abilities">Edit Abilities</button><hr><button data-action="add-alt">Add/Change Alternative</button><button data-action="clear-alt" class="danger">Clear Alternative</button><hr><button data-action="clear-main" class="danger">Clear Main Item</button>
    </div>

    <div id="toast">Build copied!</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const ITEMS = {
                'weapons': ['Arcane Staff.png', 'Arclight Blasters.png', 'Arctic Staff.png', 'Astral Staff.png', 'Battle Bracers.png', 'Battleaxe.png', 'Bear Paws.png', 'Bedrock Mace.png', 'Black Monk Stave.png', 'Blazing Staff.png', 'Blight Staff.png', 'Bloodletter.png', 'Bloodmoon Staff.png', 'Boltcasters.png', 'Bow of Badon.png', 'Bow.png', 'Brawler Gloves.png', 'Bridled Fury.png', 'Brimstone Staff.png', 'Broadsword.png', 'Camlann Mace.png', 'Carrioncaller.png', 'Carving Sword.png', 'Chillhowl.png', 'Clarent Blade.png', 'Claws.png', 'Claymore.png', 'Crossbow.png', 'Crystal Reaper.png', 'Cursed Skull.png', 'Cursed Staff.png', 'Dagger Pair.png', 'Dagger.png', 'Damnation Staff.png', 'Dawnsong.png', 'Daybreaker.png', 'Deathgivers.png', 'Demonfang.png', 'Demonic Staff.png', 'Divine Staff.png', 'Double Bladed Staff.png', 'Dreadstorm Monach.png', 'Druidic Staff.png', 'Dualswords.png', 'Earthrune Staff.png', 'Energy Shaper.png', 'Enigmatic Staff.png', 'Evensong.png', 'Exalted Staff.png', 'Fallen Staff.png', 'Fire Staff.png', 'Fists of Avalon.png', 'Flamewalker Staff.png', 'Forcepulse Bracers.png', 'Forge Hammers.png', 'Forgebark Staff.png', 'Frost Staff.png', 'Galatine Pair.png', 'Glacial Staff.png', 'Glaive.png', 'Grailseeker.png', 'Great Arcane Staff.png', 'Great Cursed Staff.png', 'Great Frost Staff.png', 'Great Hammer.png', 'Great Holy Staff.png', 'Great Nature Staff.png', 'Greataxe.png', 'Grovekeeper.png', 'Halberd.png', 'Hallowfall.png', 'Hammer.png', 'Hand of Justice.png', 'Heavy Crossbow.png', 'Heavy Mace.png', 'Hellfire Hands.png', 'Hellspawn Staff.png', 'Heron Spear.png', 'Hoarfrost Staff.png', 'Holy Staff.png', 'Icicle Staff.png', 'Incubus Mace.png', 'Infernal Scythe.png', 'Infernal Staff.png', 'Infinity Blade.png', 'Iron Clad Staff.png', 'Ironroof Staff.png', 'Kingmaker.png', 'Lifecurse Staff.png', 'Lifetouch Staff.png', 'Light Crossbow.png', 'Lightcaller.png', 'Longbow.png', 'Mace.png', 'Malevolent Locus.png', 'Mistpiercer.png', 'Morning Star.png', 'Nature Staff.png', 'Oathkeepers.png', 'Occult Staff.png', 'Permafrost Prism.png', 'Phantom Twinblade.png', 'Pike.png', 'Polehammer.png', 'Primal Staff.png', 'Prowling Staff.png', 'Quarterstaff.png', 'Rampant Staff.png', 'Ravenstrike Cestus.png', 'Realmbreaker.png', 'Redemption Staff.png', 'Riftglaive.png', 'Rootbound Staff.png', 'Rotcaller Staff.png', 'Shadowcaller.png', 'Siegebow.png', 'Skystrider Bow.png', 'Soulscythe.png', 'Spear.png', 'Spiked Gauntlets.png', 'Spirithunter.png', 'Staff of Balance.png', 'Stillgaze Staff.png', 'Tombhammer.png', 'Trinity Spear.png', 'Truebolt Hammer.png', 'Twin Slayers.png', 'Ursine Maulers.png', 'Wailing Bow.png', 'Warbow.png',g', 'Weeping Repeater.png', 'Whispering Bow.png', 'Wild Staff.png', 'Wildfire Staff.png', 'Witchwork Staff.png'],
                'OffHands': ['Astral Aegis.png', 'Caitiff Shield.png', 'Celestial Censer.png', 'Cryptcandle.png', 'Eye of Secrets.png', 'Facebreaker.png', 'Leering Cane.png', 'Mistcaller.png', 'Muisak.png', 'Sacred Scepter.png', 'Sarcophagus.png', 'Shield.png', 'Taproot.png', 'Tome of Spells.png', 'Torch.png'],
                'Head': ['Assassin Hood.png', 'Cleric Cowl.png', 'Cowl of Purity.png', 'Cultist Cowl.png', 'Demon Helmet.png', 'Druid Cowl.png', 'Duskweaver Helmet.png', 'Feyscale Hat.png', 'Fiend Cowl.png', 'Graveguard Helmet.png', 'Guardian Helmet.png', 'Hellion Hood.png', 'Helmet of Valor.png', 'Hood of Tenacity.png', 'Hunter Hood.png', 'Judicator Helmet.png', 'Knight Helmet.png', 'Mage Cowl.png', 'Mercenary Hood.png', 'Mistwalker Hood.png', 'Royal Cowl.png', 'Royal Helmet.png', 'Royal Hood.png', 'Scholar Cowl.png', 'Soldier Helmet.png', 'Specter Hood.png', 'Stalker Hood.png'],
                'Chest': ['Armor of Valor.png', 'Assassin Jacket.png', 'Cleric Robe.png', 'Cultist Robe.png', 'Demon Armor.png', 'Druid Robe.png', 'Duskweaver Armor.png', 'Feyscale Robe.png', 'Fiend Robe.png', 'Graveguard Armor.png', 'Guardian Armor.png', 'Hellion Jacket.png', 'Hunter Jacket.png', 'Jacket of Tenacity.png', 'Judicator Armor.png', 'Knight Armor.png', 'Mage Robe.png', 'Mercenary Jacket.png', 'Mistwalker Jacket.png', 'Robe of Purity.png', 'Royal Armor.png', 'Royal Jacket.png', 'Royal Robe.png', 'Scholar Robe.png', 'Soldier Armor.png', 'Specter Jacket.png', 'Stalker Jacket.png'],
                'Shoes': ['Assassin Shoes.png', 'Boots of Valor.png', 'Cleric Sandals.png', 'Cultist Sandals.png', 'Demon Boots.png', 'Druid Sandals.png', 'Duskweaver Boots.png', 'Feyscale Sandals.png', 'Fiend Sandals.png', 'Graveguard Boots.png', 'Guardian Boots.png', 'Hellion Shoes.png', 'Hunter Shoes.png', 'Judicator Boots.png', 'Knight Boots.png', 'Mage Sandals.png', 'Mercenary Shoes.png', 'Mistwalker Shoes.png', 'Royal Boots.png', 'Royal Sandals.png', 'Royals Shoes.png', 'Sandals of Purity.png', 'Scholar Sandals.png', 'Shoes of Tenacity.png', 'Soldier Boots.png', 'Specter Shoes.png', 'Stalker Shoes.png'],
                'Capes': ['Avalonian Cape.png', 'Brecilien Cape.png', 'Bridgewatch Cape.png', 'Caerleon Cape.png', 'Cape.png', 'Demon Cape.png', 'Fort Stirling Cape.png', 'Heretic Cape.png', 'Keeper Cape.png', 'Lymhurst Cape.png', 'Martlock Cape.png', 'Morgana Cape.png', 'Smuggler Cape.png', 'Thetford Cape.png', 'Undead Cape.png'],
                'Food': ['Avalonian Beef Sandwich.png', 'Avalonian Beef Stew.png', 'Avalonian Omelette.png', 'Beef Sandwich.png', 'Beef Stew.png', 'Deadwater Eel Stew.png', 'Dusthole Crab Omelette.png', 'Omelette.png', 'Roast Pork.png', 'Roasted Puremist Snapper.png', 'Thunderfall Lurcher Sandwich.png'],
                'Potion': ['Berserk Potion.png', 'Gigantify Potion.png', 'Hellfire Potion.png', 'Poison Potion.png', 'Resistance Potion.png']
            };

            const CATEGORIES = [
                { key: 'weapons', label: 'Weapon' }, { key: 'OffHands', label: 'Off-Hand' }, { key: 'Head', label: 'Head' },
                { key: 'Chest', label: 'Chest' }, { key: 'Shoes', label: 'Shoes' }, { key: 'Capes', label: 'Cape' },
                { key: 'Food', label: 'Food' }, { key: 'Potion', label: 'Potion' }
            ];

            const ROLES = [
                { id: 'engage', name: 'Engage', color: 'bg-purple-800' }, { id: 'tanks', name: 'Tanks', color: 'bg-blue-800' },
                { id: 'support', name: 'Support', color: 'bg-yellow-800' }, { id: 'healer', name: 'Healer', color: 'bg-green-800' },
                { id: 'dps', name: 'DPS', color: 'bg-red-800' }
            ];
            const EXPORT_COLUMN_1_ROLES = ['engage', 'tanks', 'support'];
            const EXPORT_COLUMN_2_ROLES = ['healer', 'dps'];
            const BUILD_LIBRARY_STORAGE_KEY = 'albionBuildLibrary';

            /* ----------------- STATE VARIABLES ---------------- */
            let activeSlot = null;
            let activeCategory = null;
            let copiedBuildData = null;
            let draggedBuildRow = null;
            let draggedRoleColumn = null;
            let logoImageSrc = null;
            let backgroundImageSrc = null;
            let isSelectingAlternative = false;
            let activeBuildRowForSave = null;
            let activeRoleForLoad = null;

            // Style state
            let titleFontSize = '36'; let titleColor = '#E2E8F0'; let titleAlign = 'center';
            let notesFontSize = '16'; let notesColor = '#CBD5E0'; let notesAlign = 'left'; let notesPosition = 'above_full';

            // Party table state
            let partyTableData = []; let isPartyTableEnabled = false; let partyTablePosition = 'above_full'; let partyTableScale = 1;

            /* ----------------- DOM ELEMENTS ---------------- */
            const compContainer = document.getElementById('comp-container');
            const rolesContainer = document.getElementById('roles-container');
            const itemModal = document.getElementById('item-modal');
            const abilityModal = document.getElementById('ability-modal');
            const saveBuildModal = document.getElementById('save-build-modal');
            const loadBuildModal = document.getElementById('load-build-modal');
            const modalGrid = document.getElementById('modal-grid');
            const closeModalBtn = document.getElementById('close-modal');
            const itemSearch = document.getElementById('item-search');
            const exportBtn = document.getElementById('export-btn');
            const uploadCustomBtn = document.getElementById('upload-custom-btn');
            const customImageUpload = document.getElementById('custom-image-upload');
            const compTitleInput = document.getElementById('comp-title');
            const compNotesInput = document.getElementById('comp-notes');
            const logoPreview = document.getElementById('logo-preview');
            const compLogoUpload = document.getElementById('comp-logo-upload');
            const uploadLogoBtn = document.getElementById('upload-logo-btn');
            const removeLogoBtn = document.getElementById('remove-logo-btn');
            const backgroundUploadInput = document.getElementById('background-upload-input');
            const uploadBackgroundBtn = document.getElementById('upload-background-btn');
            const removeBackgroundBtn = document.getElementById('remove-background-btn');
            const contextMenu = document.getElementById('item-context-menu');
            const toast = document.getElementById('toast');
            const saveBtn = document.getElementById('save-btn');
            const loadBtn = document.getElementById('load-btn');
            const loadFileInput = document.getElementById('load-file-input');
            const abilityInput = document.getElementById('ability-input');
            const abilitySaveBtn = document.getElementById('ability-save-btn');
            const abilityCancelBtn = document.getElementById('ability-cancel-btn');
            const titleFontSizeSlider = document.getElementById('title-font-size');
            const titleFontSizeValue = document.getElementById('title-font-size-value');
            const titleColorPicker = document.getElementById('title-font-color');
            const titleAlignGroup = document.getElementById('title-align-group');
            const notesFontSizeSlider = document.getElementById('notes-font-size');
            const notesFontSizeValue = document.getElementById('notes-font-size-value');
            const notesColorPicker = document.getElementById('notes-font-color');
            const notesAlignGroup = document.getElementById('notes-align-group');
            const notesPositionSelect = document.getElementById('notes-position-select');
            const tabButtonsContainer = document.querySelector('.tab-buttons');
            const enablePartyTableCheck = document.getElementById('enable-party-table');
            const partyTableControls = document.getElementById('party-table-controls');
            const partyTableBody = document.getElementById('party-table-body');
            const addPartyRowBtn = document.getElementById('add-party-row-btn');
            const partyTablePositionSelect = document.getElementById('party-table-position-select');
            const partyTableScaleSlider = document.getElementById('party-table-scale');
            const partyTableScaleValue = document.getElementById('party-table-scale-value');

            /* ----------------- ROLE & BUILD FUNCTIONS ---------------- */
            function createRoleSection(role) {
                const section = document.createElement('div');
                section.id = role.id;
                section.className = 'role-section';
                section.draggable = true;

                section.innerHTML = `
                    <div class="role-header">
                        <span class="role-drag-handle" title="Drag to reorder role">⠿</span>
                        <button class="role-collapse-toggle" title="Collapse/Expand Role">▼</button>
                        <h2 class="role-title font-bold ${role.color.replace('bg-', 'text-').replace('-800', '-300')}">${role.name}</h2>
                        <div class="flex space-x-2 ml-auto pl-2 flex-shrink-0">
                            <button class="load-library-btn bg-purple-600 hover:bg-purple-500 text-white font-bold py-1 px-2 rounded text-xs" data-role="${role.id}">Load</button>
                            <button class="paste-build-btn bg-blue-600 hover:bg-blue-500 text-white font-bold py-1 px-2 rounded text-xs hidden" data-role="${role.id}">Paste</button>
                            <button class="add-build-btn bg-gray-700 hover:bg-gray-600 text-white font-bold py-1 px-2 rounded text-xs" data-role="${role.id}">+ Add</button>
                        </div>
                    </div>
                    <div class="builds-container" data-role="${role.id}"></div>
                `;
                rolesContainer.appendChild(section);
                section.addEventListener('dragstart', handleRoleDragStart);
                section.addEventListener('dragend', handleRoleDragEnd);
                section.addEventListener('touchstart', handleRoleTouchStart, { passive: false });
                section.addEventListener('touchmove', handleRoleTouchMove, { passive: false });
                section.addEventListener('touchend', handleRoleTouchEnd);
            }

            function createBuildRow(buildData = { slots: [] }) {
                const buildRow = document.createElement('div');
                buildRow.className = 'build-row';
                buildRow.draggable = true;

                let buildSlots = buildData.slots;
                if (!buildSlots || buildSlots.length === 0) {
                    buildSlots = Array.from({ length: CATEGORIES.length }, () => ({ primary: null, alt: null, quantity: 1, abilities: '', partyQuantity: '' }));
                }

                const slotsHTML = CATEGORIES.map((cat, index) => {
                    const slotData = buildSlots[index] || { primary: null, alt: null, quantity: 1, abilities: '' };
                    const quantity = slotData.quantity || 1;
                    const abilitiesText = slotData.abilities || '';
                    // Try to find original filename for alt text from primary image source URL
                    const primaryImgSrc = slotData.primary || "";
                    let primaryItemName = "item";
                    if (primaryImgSrc && ITEMS[cat.key]) {
                        primaryItemName = ITEMS[cat.key].find(item => primaryImgSrc.includes(`/${item}`)) || primaryImgSrc.substring(primaryImgSrc.lastIndexOf('/') + 1);
                    }
                    const primaryImgHTML = slotData.primary ? `<img src="${primaryImgSrc}" alt="${primaryItemName}" class="primary-item-img">` : '';
                    const altImgHTML = slotData.alt ? `<img src="${slotData.alt}" alt="alternative item">` : '';
                    const borderColorStyle = slotData.primary ? 'border-color: transparent;' : '';

                    return `
                        <div class="item-slot-wrapper" data-category="${cat.key}">
                            <div class="item-slot" style="${borderColorStyle}" data-quantity="${quantity}">
                                <div class="ability-text-overlay">${abilitiesText}</div>
                                ${primaryImgHTML}
                                <div class="alternative-item-overlay">${altImgHTML}</div>
                                <input type="number" class="quantity-input" min="1" value="${quantity}">
                                <span class="item-quantity">x${quantity}</span>
                            </div>
                            <span class="category-label"></span>
                        </div>
                    `;
                }).join('');

                const partyQuantity = buildData.partyQuantity || '';
                buildRow.innerHTML = `
                    <div class="build-quantity-container flex flex-col items-center justify-center">
                        <input type="text" class="build-quantity-input" placeholder="x?" value="${partyQuantity}">
                        <span class="build-quantity-display">${partyQuantity}</span>
                    </div>
                    <div class="build-drag-handle self-stretch flex items-center pr-2 mr-2 border-r border-gray-700">⠿</div>
                    <div class="build-items-wrapper">${slotsHTML}</div>
                    <div class="flex flex-col space-y-1 ml-2 sm:ml-4 self-center">
                        <button class="save-build-btn text-green-400 hover:text-green-300 font-bold text-lg" title="Save Build to Library">💾</button>
                        <button class="copy-build-btn text-blue-400 hover:text-blue-300 font-bold text-lg" title="Copy Build">⧉</button>
                        <button class="export-single-build-btn text-purple-400 hover:text-purple-300 font-bold text-lg" title="Export Build as PNG">📸</button> <button class="remove-build-btn text-red-500 hover:text-red-400 font-bold text-2xl" title="Remove Build">&times;</button>
                    </div>
                `;

                buildRow.addEventListener('dragstart', handleBuildDragStart);
                buildRow.addEventListener('dragend', handleBuildDragEnd);
                buildRow.addEventListener('dragover', handleBuildDragOver);
                buildRow.addEventListener('touchstart', handleBuildTouchStart, { passive: false });
                buildRow.addEventListener('touchmove', handleBuildTouchMove, { passive: false });
                buildRow.addEventListener('touchend', handleBuildTouchEnd);

                buildRow.addEventListener('input', (e) => {
                    if (e.target.classList.contains('quantity-input')) {
                        let val = parseInt(e.target.value);
                        if (isNaN(val) || val < 1) val = 1;
                        e.target.value = val;
                        const itemSlot = e.target.closest('.item-slot');
                        itemSlot.dataset.quantity = val;
                        const displayQuantity = itemSlot.querySelector('.item-quantity');
                        if (displayQuantity) displayQuantity.textContent = `x${val}`;
                    }
                    if (e.target.classList.contains('build-quantity-input')) {
                        e.target.nextElementSibling.textContent = e.target.value;
                    }
                });
                return buildRow;
            }

            /* ----------------- DRAG & DROP HANDLERS (DESKTOP) ---------------- */
            function handleBuildDragStart(e) {
                if (e.target.classList.contains('build-drag-handle')) {
                    draggedBuildRow = e.currentTarget;
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', null);
                    setTimeout(() => { draggedBuildRow.classList.add('opacity-50', 'dragging'); }, 0);
                } else { e.preventDefault(); }
            }
            function handleBuildDragEnd(e) { if (draggedBuildRow) draggedBuildRow.classList.remove('opacity-50', 'dragging'); draggedBuildRow = null; }
            function handleBuildDragOver(e) {
                e.preventDefault();
                const targetRow = e.currentTarget.closest('.build-row');
                if (!draggedBuildRow || draggedBuildRow === targetRow || !targetRow) return;
                const container = targetRow.parentElement;
                if (draggedBuildRow.parentElement !== container) return;
                const rect = targetRow.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;
                if (e.clientY < midpoint) container.insertBefore(draggedBuildRow, targetRow);
                else container.insertBefore(draggedBuildRow, targetRow.nextSibling);
            }
            function handleRoleDragStart(e) {
                if (e.target.classList.contains('role-drag-handle')) {
                    draggedRoleColumn = e.currentTarget;
                    e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', null);
                    setTimeout(() => { draggedRoleColumn.classList.add('dragging'); }, 0);
                } else { if (!e.target.closest('.build-drag-handle')) e.preventDefault(); }
            }
            function handleRoleDragEnd(e) { if (draggedRoleColumn) draggedRoleColumn.classList.remove('dragging'); draggedRoleColumn = null; }
            function handleRoleDragOver(e) {
                e.preventDefault();
                const targetRole = e.target.closest('.role-section');
                if (!draggedRoleColumn || draggedRoleColumn === targetRole || !targetRole) return;
                const rect = targetRole.getBoundingClientRect();
                const firstRoleTop = rolesContainer.children[0].getBoundingClientRect().top;
                const targetRoleTop = rect.top;
                const isWrapped = Math.abs(firstRoleTop - targetRoleTop) > rect.height / 2;
                if (isWrapped) {
                    const midpointY = rect.top + rect.height / 2;
                    if (e.clientY < midpointY) rolesContainer.insertBefore(draggedRoleColumn, targetRole);
                    else rolesContainer.insertBefore(draggedRoleColumn, targetRole.nextSibling);
                } else {
                    const midpointX = rect.left + rect.width / 2;
                    if (e.clientX < midpointX) rolesContainer.insertBefore(draggedRoleColumn, targetRole);
                    else rolesContainer.insertBefore(draggedRoleColumn, targetRole.nextSibling);
                }
            }

            /* ----------------- DRAG & DROP HANDLERS (MOBILE/TOUCH) ---------------- */
            function handleBuildTouchStart(e) { if (e.target.classList.contains('build-drag-handle')) { draggedBuildRow = e.currentTarget; draggedBuildRow.classList.add('opacity-50', 'dragging'); e.preventDefault(); } }
            function handleBuildTouchMove(e) {
                if (!draggedBuildRow) return; e.preventDefault();
                const touch = e.touches[0]; const targetElement = document.elementFromPoint(touch.clientX, touch.clientY);
                const targetRow = targetElement ? targetElement.closest('.build-row') : null;
                if (!targetRow || targetRow === draggedBuildRow || !draggedBuildRow.parentElement.contains(targetRow)) return;
                const rect = targetRow.getBoundingClientRect(); const midpoint = rect.top + rect.height / 2;
                if (touch.clientY < midpoint) { targetRow.parentElement.insertBefore(draggedBuildRow, targetRow); } else { targetRow.parentElement.insertBefore(draggedBuildRow, targetRow.nextSibling); }
            }
            function handleBuildTouchEnd(e) { if (draggedBuildRow) { draggedBuildRow.classList.remove('opacity-50', 'dragging'); draggedBuildRow = null; } }
            function handleRoleTouchStart(e) { if (e.target.classList.contains('role-drag-handle')) { draggedRoleColumn = e.currentTarget; draggedRoleColumn.classList.add('dragging'); e.preventDefault(); } }
            function handleRoleTouchMove(e) {
                if (!draggedRoleColumn) return; e.preventDefault();
                const touch = e.touches[0]; const targetElement = document.elementFromPoint(touch.clientX, touch.clientY);
                const targetRole = targetElement ? targetElement.closest('.role-section') : null;
                if (!targetRole || targetRole === draggedRoleColumn || !rolesContainer.contains(targetRole)) return;
                const rect = targetRole.getBoundingClientRect(); const firstRoleTop = rolesContainer.children[0].getBoundingClientRect().top;
                const targetRoleTop = rect.top; const isWrapped = Math.abs(firstRoleTop - targetRoleTop) > rect.height / 2;
                if (isWrapped) {
                    const midpointY = rect.top + rect.height / 2;
                    if (touch.clientY < midpointY) rolesContainer.insertBefore(draggedRoleColumn, targetRole); else rolesContainer.insertBefore(draggedRoleColumn, targetRole.nextSibling);
                } else {
                    const midpointX = rect.left + rect.width / 2;
                    if (touch.clientX < midpointX) rolesContainer.insertBefore(draggedRoleColumn, targetRole); else rolesContainer.insertBefore(draggedRoleColumn, targetRole.nextSibling);
                }
            }
            function handleRoleTouchEnd(e) { if (draggedRoleColumn) { draggedRoleColumn.classList.remove('dragging'); draggedRoleColumn = null; } }

            /* ----------------- MODAL FUNCTIONS ---------------- */
            function populateModal(category) {
                modalGrid.innerHTML = '';
                const items = ITEMS[category] || [];
                const searchTerm = itemSearch.value.toLowerCase();
                items.filter(item => item.toLowerCase().includes(searchTerm)).forEach(itemFilename => {
                    const itemDiv = document.createElement('div');
                    const imagePath = `./images/${category}/${itemFilename}`; 
                    itemDiv.className = 'cursor-pointer p-1 bg-gray-700 rounded-lg hover:bg-gray-600 flex items-center justify-center flex-col';
                    itemDiv.innerHTML = `<img src="${imagePath}" alt="${itemFilename}" class="w-16 h-16 object-contain" style="background-color: #4a5568;"><span class="text-xs text-center mt-1 text-gray-300 break-words w-full">${itemFilename.replace('.png', '')}</span>`;
                    itemDiv.addEventListener('click', () => selectItem(imagePath, itemFilename)); 
                    itemDiv.querySelector('img').onerror = function() { this.style.visibility = 'hidden'; };
                    modalGrid.appendChild(itemDiv);
                });
            }
            function openModal(slotElement) {
                activeSlot = slotElement; activeCategory = slotElement.closest('.item-slot-wrapper').dataset.category;
                const categoryInfo = CATEGORIES.find(c => c.key === activeCategory); document.getElementById('modal-category-tag').textContent = categoryInfo ? categoryInfo.label : activeCategory;
                itemSearch.value = ''; populateModal(activeCategory); itemModal.classList.remove('hidden');
            }
            function closeModal() { itemModal.classList.add('hidden'); activeSlot = null; activeCategory = null; isSelectingAlternative = false; }
            function openAbilityModal() { if (!activeSlot) return; abilityInput.value = activeSlot.querySelector('.ability-text-overlay')?.textContent || ''; abilityModal.classList.remove('hidden'); abilityInput.focus(); }
            function closeAbilityModal() { abilityModal.classList.add('hidden'); }
            function selectItem(imageSrc, altText = 'custom-item') {
                if (!activeSlot) return;
                if (isSelectingAlternative) { activeSlot.querySelector('.alternative-item-overlay').innerHTML = `<img src="${imageSrc}" alt="alternative item">`; } 
                else {
                    const currentQuantity = parseInt(activeSlot.dataset.quantity || 1); const altContent = activeSlot.querySelector('.alternative-item-overlay')?.innerHTML || '';
                    const abilityContent = activeSlot.querySelector('.ability-text-overlay')?.textContent || '';
                    activeSlot.innerHTML = `<div class="ability-text-overlay">${abilityContent}</div><img src="${imageSrc}" alt="${altText}" class="primary-item-img"><div class="alternative-item-overlay">${altContent}</div><input type="number" class="quantity-input" min="1" value="${currentQuantity}"><span class="item-quantity">x${currentQuantity}</span>`;
                    activeSlot.style.borderColor = 'transparent';
                }
                closeModal();
            }

            /* ----------------- ACTION HANDLERS ---------------- */
            function getBuildDataFromRow(buildRowElement) {
                const buildSlotsData = CATEGORIES.map((cat, i) => {
                    const slot = buildRowElement.querySelectorAll('.item-slot')[i];
                    if (slot) {
                        const primaryImg = slot.querySelector('.primary-item-img'); const altImg = slot.querySelector('.alternative-item-overlay img');
                        return { primary: primaryImg ? primaryImg.src : null, alt: altImg ? altImg.src : null, quantity: parseInt(slot.dataset.quantity || 1), abilities: slot.querySelector('.ability-text-overlay')?.textContent || '' };
                    } return { primary: null, alt: null, quantity: 1, abilities: '' };
                });
                return { slots: buildSlotsData, partyQuantity: buildRowElement.querySelector('.build-quantity-input')?.value || '' };
            }
            function copyBuild(buildRowElement) { copiedBuildData = getBuildDataFromRow(buildRowElement); document.querySelectorAll('.paste-build-btn').forEach(btn => btn.classList.remove('hidden')); showToast("Build copied!"); }
            function pasteBuild(roleId) { if (copiedBuildData) document.querySelector(`#${roleId} .builds-container`).appendChild(createBuildRow(copiedBuildData)); }
            function clearSlot(slotElement, partToClear = 'main') {
                if (partToClear === 'main') {
                    const currentQuantity = parseInt(slotElement.dataset.quantity || 1); const abilityContent = slotElement.querySelector('.ability-text-overlay')?.textContent || '';
                    slotElement.innerHTML = `<div class="ability-text-overlay">${abilityContent}</div><div class="alternative-item-overlay"></div><input type="number" class="quantity-input" min="1" value="${currentQuantity}"><span class="item-quantity">x${currentQuantity}</span>`;
                    slotElement.style.borderColor = '';
                } else if (partToClear === 'alt') { const overlay = slotElement.querySelector('.alternative-item-overlay'); if (overlay) overlay.innerHTML = ''; }
            }
            function showToast(message) { toast.textContent = message; toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); }, 2000); }
            function updateLogoTitleDisplay() { if (logoImageSrc) { logoPreview.src = logoImageSrc; logoPreview.classList.remove('hidden'); removeLogoBtn.classList.remove('hidden'); } else { logoPreview.classList.add('hidden'); removeLogoBtn.classList.add('hidden'); logoPreview.src = ''; } }
            function applyBackground() { if (backgroundImageSrc) { compContainer.style.backgroundImage = `url(${backgroundImageSrc})`; compContainer.style.backgroundSize = 'cover'; compContainer.style.backgroundPosition = 'center'; removeBackgroundBtn.classList.remove('hidden'); } else { compContainer.style.backgroundImage = 'none'; removeBackgroundBtn.classList.add('hidden'); } }

            /* ----------------- BUILD LIBRARY (localStorage) FUNCTIONS ---------------- */
            function getBuildLibrary() { return JSON.parse(localStorage.getItem(BUILD_LIBRARY_STORAGE_KEY) || '{}'); }
            function saveBuildToLibrary(category, buildName, buildData) { const library = getBuildLibrary(); if (!library[category]) { library[category] = []; } const existingBuildIndex = library[category].findIndex(build => build.name === buildName); if (existingBuildIndex > -1) library[category][existingBuildIndex] = { name: buildName, data: buildData }; else library[category].push({ name: buildName, data: buildData }); localStorage.setItem(BUILD_LIBRARY_STORAGE_KEY, JSON.stringify(library)); showToast(`Build "${buildName}" saved to category "${category}"!`); }
            function deleteBuildFromLibrary(category, buildName) { const library = getBuildLibrary(); if (library[category]) { library[category] = library[category].filter(build => build.name !== buildName); if (library[category].length === 0) delete library[category]; localStorage.setItem(BUILD_LIBRARY_STORAGE_KEY, JSON.stringify(library)); populateLoadBuildModal(); showToast(`Build "${buildName}" deleted.`); } }
            function openSaveBuildModal(buildRowElement) { activeBuildRowForSave = buildRowElement; const library = getBuildLibrary(); const categorySelect = document.getElementById('save-build-category-select'); categorySelect.innerHTML = '<option value="">Select existing category...</option>'; Object.keys(library).sort().forEach(category => { categorySelect.innerHTML += `<option value="${category}">${category}</option>`; }); document.getElementById('save-build-name').value = ''; document.getElementById('save-build-new-category').value = ''; saveBuildModal.classList.remove('hidden'); }
            function populateLoadBuildModal() { 
                const library = getBuildLibrary(); const container = document.getElementById('load-build-library-content'); container.innerHTML = ''; if (Object.keys(library).length === 0) { container.innerHTML = '<p class="text-gray-400 text-center">Your build library is empty.</p>'; return; } 
                const categoryGrid = document.createElement('div'); categoryGrid.className = "space-y-4";
                Object.keys(library).sort().forEach(category => { 
                    const categoryGroup = document.createElement('div'); categoryGroup.className = 'category-group border border-gray-700 rounded-lg p-3'; 
                    categoryGroup.innerHTML = `<h3 class="category-title text-lg font-bold text-blue-300 mb-2">${category}</h3>`; 
                    const buildsList = document.createElement('div'); buildsList.className = "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2";
                    library[category].sort((a, b) => a.name.localeCompare(b.name)).forEach(build => { 
                        const buildEntry = document.createElement('div'); buildEntry.className = 'saved-build-entry flex justify-between items-center bg-gray-800 p-2 rounded'; 
                        buildEntry.innerHTML = `<span class="saved-build-name text-sm text-gray-200 truncate pr-2">${build.name}</span> <div class="flex-shrink-0 space-x-1"> <button class="load-saved-build-btn bg-blue-600 hover:bg-blue-500 text-white py-1 px-2 rounded text-xs" data-build-json='${JSON.stringify(build.data)}'>Load</button> <button class="delete-build-btn text-red-400 hover:text-red-300 text-xs py-1 px-2 rounded" data-category="${category}" data-name="${build.name}">&times;</button> </div>`; 
                        buildsList.appendChild(buildEntry); 
                    }); 
                    categoryGroup.appendChild(buildsList); categoryGrid.appendChild(categoryGroup);
                }); 
                container.appendChild(categoryGrid);
            }

            /* ----------------- PARTY TABLE FUNCTIONS ---------------- */
            function initializePartyTable() {
                const defaultData = [ { partySize: 10, engages: 1, tanks: 2, supports: 1, healers: 2, dps: 4 }, { partySize: 11, engages: 1, tanks: 2, supports: 1, healers: 2, dps: 5 }, { partySize: 12, engages: 1, tanks: 2, supports: 2, healers: 2, dps: 5 }, { partySize: 13, engages: 1, tanks: 2, supports: 2, healers: 3, dps: 5 }, { partySize: 14, engages: 1, tanks: 3, supports: 2, healers: 3, dps: 5 }, ];
                partyTableData = defaultData; renderPartyTable();
            }
            function renderPartyTable() {
                partyTableBody.innerHTML = '';
                partyTableData.forEach((rowData, index) => {
                    const tr = document.createElement('tr'); tr.dataset.index = index;
                    tr.innerHTML = `<td><input type="number" class="w-16 bg-transparent font-bold text-center" value="${rowData.partySize}" data-key="partySize"></td> <td><input type="number" min="0" value="${rowData.engages}" data-key="engages"></td> <td><input type="number" min="0" value="${rowData.tanks}" data-key="tanks"></td> <td><input type="number" min="0" value="${rowData.supports}" data-key="supports"></td> <td><input type="number" min="0" value="${rowData.healers}" data-key="healers"></td> <td><input type="number" min="0" value="${rowData.dps}" data-key="dps"></td>`;
                    partyTableBody.appendChild(tr);
                });
            }
            function addNewPartyTableRow() { const lastRow = partyTableData.length > 0 ? partyTableData[partyTableData.length - 1] : { partySize: 9 }; const newPartySize = lastRow.partySize + 1; partyTableData.push({ partySize: newPartySize, engages: 0, tanks: 0, supports: 0, healers: 0, dps: 0 }); renderPartyTable(); }
            function createExportableTableClone() {
                const tableClone = document.createElement('table'); tableClone.id = 'party-table-clone'; tableClone.style.transform = `scale(${partyTableScale})`;
                const thead = document.createElement('thead'); thead.innerHTML = `<tr><th>Party size</th><th>Engages</th><th>Tanks</th><th>Supports</th><th>Healers</th><th>DPS</th></tr>`; tableClone.appendChild(thead);
                const tbody = document.createElement('tbody');
                partyTableData.forEach(rowData => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${rowData.partySize}</td><td>${rowData.engages}</td><td>${rowData.tanks}</td><td>${rowData.supports}</td><td>${rowData.healers}</td><td>${rowData.dps}</td>`; tbody.appendChild(tr); });
                tableClone.appendChild(tbody); return tableClone;
            }

            /* ----------------- SAVE/LOAD COMPOSITION FUNCTIONS ---------------- */
            function saveComposition() {
                partyTableData = Array.from(partyTableBody.querySelectorAll('tr')).map(row => ({ partySize: parseInt(row.querySelector('[data-key="partySize"]').value) || 0, engages: parseInt(row.querySelector('[data-key="engages"]').value) || 0, tanks: parseInt(row.querySelector('[data-key="tanks"]').value) || 0, supports: parseInt(row.querySelector('[data-key="supports"]').value) || 0, healers: parseInt(row.querySelector('[data-key="healers"]').value) || 0, dps: parseInt(row.querySelector('[data-key="dps"]').value) || 0, }));
                const compositionData = { title: compTitleInput.value, notes: compNotesInput.value, logoSrc: logoImageSrc, backgroundImageSrc: backgroundImageSrc, styles: { titleFontSize, titleColor, titleAlign, notesFontSize, notesColor, notesAlign, notesPosition }, partyTableSettings: { isEnabled: isPartyTableEnabled, position: partyTablePosition, scale: partyTableScale, data: partyTableData }, roleOrder: Array.from(rolesContainer.children).map(role => role.id), roleStates: {}, roles: {} };
                document.querySelectorAll('.role-section').forEach(roleSection => { const roleId = roleSection.id; compositionData.roles[roleId] = Array.from(roleSection.querySelectorAll('.build-row')).map(row => getBuildDataFromRow(row)); compositionData.roleStates[roleId] = { isCollapsed: roleSection.classList.contains('collapsed') }; });
                const dataStr = JSON.stringify(compositionData, null, 2); const dataBlob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.download = `${compositionData.title.replace(/[^a-z0-9]/gi, '_') || 'composition'}.json`; link.href = url; link.click(); URL.revokeObjectURL(url); showToast("Composition saved!");
            }
            function loadComposition(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const loadedData = JSON.parse(e.target.result); compTitleInput.value = loadedData.title || ''; compNotesInput.value = loadedData.notes || ''; logoImageSrc = loadedData.logoSrc || null; backgroundImageSrc = loadedData.backgroundImageSrc || null;
                        const styles = loadedData.styles || {}; titleFontSize = styles.titleFontSize || '36'; titleColor = styles.titleColor || '#E2E8F0'; titleAlign = styles.titleAlign || 'center'; notesFontSize = styles.notesFontSize || '16'; notesColor = styles.notesColor || '#CBD5E0'; notesAlign = styles.notesAlign || 'left'; notesPosition = styles.notesPosition || 'above_full';
                        if (loadedData.partyTableSettings) { partyTableData = loadedData.partyTableSettings.data || []; isPartyTableEnabled = loadedData.partyTableSettings.isEnabled || false; partyTablePosition = loadedData.partyTableSettings.position || 'above_full'; partyTableScale = loadedData.partyTableSettings.scale || 1; if (partyTableData.length === 0) initializePartyTable(); } else { initializePartyTable(); }
                        renderPartyTable(); applyCurrentStylesToEditor(); updateLogoTitleDisplay(); applyBackground();
                        rolesContainer.innerHTML = ''; const roleOrder = loadedData.roleOrder || ROLES.map(r => r.id); const loadedRoleIds = new Set(roleOrder); const missingRoles = ROLES.filter(r => !loadedRoleIds.has(r.id)); roleOrder.forEach(roleId => { const config = ROLES.find(r => r.id === roleId); if (config) createRoleSection(config); }); missingRoles.forEach(createRoleSection);
                        document.querySelectorAll('.role-section').forEach(roleSection => { const roleId = roleSection.id; const buildsContainer = roleSection.querySelector('.builds-container'); buildsContainer.innerHTML = ''; const roleBuilds = loadedData.roles[roleId]; if (roleBuilds && Array.isArray(roleBuilds) && roleBuilds.length > 0) { roleBuilds.forEach(buildData => buildsContainer.appendChild(createBuildRow(buildData))); } else { buildsContainer.appendChild(createBuildRow()); } if (loadedData.roleStates && loadedData.roleStates[roleId] && loadedData.roleStates[roleId].isCollapsed) { roleSection.classList.add('collapsed'); roleSection.querySelector('.role-collapse-toggle').textContent = '►'; } });
                        showToast("Composition loaded successfully!");
                    } catch (error) { console.error("Error parsing load file:", error); showToast("Error: Could not load file. Invalid format."); }
                }; reader.readAsText(file);
            }
            function applyCurrentStylesToEditor() {
                compTitleInput.style.fontSize = `${titleFontSize}px`; compTitleInput.style.color = titleColor; compTitleInput.style.textAlign = titleAlign; titleFontSizeSlider.value = titleFontSize; titleFontSizeValue.textContent = `${titleFontSize}px`; titleColorPicker.value = titleColor; updateAlignmentButtons(titleAlignGroup, titleAlign);
                compNotesInput.style.fontSize = `${notesFontSize}px`; compNotesInput.style.color = notesColor; compNotesInput.style.textAlign = notesAlign; notesFontSizeSlider.value = notesFontSize; notesFontSizeValue.textContent = `${notesFontSize}px`; notesColorPicker.value = notesColor; updateAlignmentButtons(notesAlignGroup, notesAlign); notesPositionSelect.value = notesPosition;
                enablePartyTableCheck.checked = isPartyTableEnabled; partyTableControls.style.display = isPartyTableEnabled ? 'block' : 'none'; partyTablePositionSelect.value = partyTablePosition; partyTableScaleSlider.value = partyTableScale; partyTableScaleValue.textContent = `${Math.round(partyTableScale * 100)}%`;
            }
            function updateAlignmentButtons(buttonGroup, activeAlignment) { buttonGroup.querySelectorAll('button').forEach(btn => { btn.classList.toggle('active', btn.dataset.align === activeAlignment); }); }

            /* ----------------- EVENT LISTENERS SETUP ---------------- */
            rolesContainer.addEventListener('click', e => {
                const target = e.target; const buildRow = target.closest('.build-row');
                if (target.closest('.add-build-btn')) { const roleId = target.closest('.add-build-btn').dataset.role; document.querySelector(`#${roleId} .builds-container`).appendChild(createBuildRow()); }
                else if (target.closest('.load-library-btn')) { activeRoleForLoad = target.closest('.load-library-btn').dataset.role; populateLoadBuildModal(); loadBuildModal.classList.remove('hidden'); }
                else if (target.closest('.save-build-btn')) { openSaveBuildModal(buildRow); }
                else if (target.closest('.paste-build-btn')) { pasteBuild(target.closest('.paste-build-btn').dataset.role); }
                else if (target.closest('.remove-build-btn')) { buildRow.remove(); }
                else if (target.closest('.copy-build-btn')) { copyBuild(buildRow); }
                else if (target.closest('.export-single-build-btn')) { exportSingleBuild(buildRow); } /* --- ADDITION --- */
                else if (target.closest('.item-slot') && !target.classList.contains('quantity-input')) { isSelectingAlternative = false; openModal(target.closest('.item-slot')); }
                else if (target.closest('.role-collapse-toggle')) { const roleSection = target.closest('.role-section'); roleSection.classList.toggle('collapsed'); target.textContent = roleSection.classList.contains('collapsed') ? '►' : '▼'; }
            });
            rolesContainer.addEventListener('dragover', handleRoleDragOver);

            contextMenu.addEventListener('contextmenu', e => e.preventDefault());
            rolesContainer.addEventListener('contextmenu', e => {
                const slot = e.target.closest('.item-slot');
                if (slot) {
                    activeSlot = slot; const hasPrimary = !!slot.querySelector('.primary-item-img');
                    if (hasPrimary) {
                        e.preventDefault(); contextMenu.classList.remove('hidden'); const hasAlt = !!slot.querySelector('.alternative-item-overlay img');
                        contextMenu.querySelector('[data-action="edit-abilities"]').style.display = 'block'; contextMenu.querySelector('[data-action="add-alt"]').style.display = 'block'; contextMenu.querySelector('[data-action="clear-alt"]').style.display = hasAlt ? 'block' : 'none'; contextMenu.querySelector('[data-action="clear-main"]').style.display = 'block';
                        const { clientX: mouseX, clientY: mouseY } = e; const { innerWidth, innerHeight } = window; const menuWidth = contextMenu.offsetWidth; const menuHeight = contextMenu.offsetHeight;
                        contextMenu.style.top = `${mouseY + menuHeight > innerHeight ? innerHeight - menuHeight - 5 : mouseY}px`; contextMenu.style.left = `${mouseX + menuWidth > innerWidth ? innerWidth - menuWidth - 5 : mouseX}px`;
                    }
                }
            });
            document.addEventListener('click', (e) => { if (!contextMenu.contains(e.target)) contextMenu.classList.add('hidden'); });
            contextMenu.addEventListener('click', e => { const action = e.target.dataset.action; if (!activeSlot) return; switch(action) { case 'edit-abilities': openAbilityModal(); break; case 'add-alt': isSelectingAlternative = true; openModal(activeSlot); break; case 'clear-alt': clearSlot(activeSlot, 'alt'); break; case 'clear-main': clearSlot(activeSlot, 'main'); break; } contextMenu.classList.add('hidden'); });

            abilitySaveBtn.addEventListener('click', () => { if(activeSlot) activeSlot.querySelector('.ability-text-overlay').textContent = abilityInput.value; closeAbilityModal(); });
            abilityCancelBtn.addEventListener('click', closeAbilityModal);
            abilityInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); abilitySaveBtn.click(); } });

            closeModalBtn.addEventListener('click', closeModal); itemModal.addEventListener('click', e => { if (e.target === itemModal) closeModal(); }); itemSearch.addEventListener('input', () => { if (activeCategory) populateModal(activeCategory); });

            document.getElementById('save-build-confirm-btn').addEventListener('click', () => { const buildNameInput = document.getElementById('save-build-name'); const newCategoryInput = document.getElementById('save-build-new-category'); const existingCategorySelect = document.getElementById('save-build-category-select'); const buildName = buildNameInput.value.trim(); const category = newCategoryInput.value.trim() || existingCategorySelect.value; if (!buildName) { showToast("Please enter a build name."); return; } if (!category) { showToast("Please select or create a category."); return; } saveBuildToLibrary(category, buildName, getBuildDataFromRow(activeBuildRowForSave)); saveBuildModal.classList.add('hidden'); });
            document.getElementById('save-build-cancel-btn').addEventListener('click', () => saveBuildModal.classList.add('hidden'));
            document.getElementById('load-build-close-btn').addEventListener('click', () => loadBuildModal.classList.add('hidden'));
            document.getElementById('load-build-library-content').addEventListener('click', e => { const loadButton = e.target.closest('.load-saved-build-btn'); const deleteButton = e.target.closest('.delete-build-btn'); if (loadButton) { const buildsContainer = document.querySelector(`#${activeRoleForLoad} .builds-container`); buildsContainer.appendChild(createBuildRow(JSON.parse(loadButton.dataset.buildJson))); loadBuildModal.classList.add('hidden'); } else if (deleteButton) { if (confirm(`Delete build "${deleteButton.dataset.name}"?`)) deleteBuildFromLibrary(deleteButton.dataset.category, deleteButton.dataset.name); } });

            uploadCustomBtn.addEventListener('click', () => customImageUpload.click());
            customImageUpload.addEventListener('change', (e) => { const file = e.target.files[0]; if (file && activeSlot) { const reader = new FileReader(); reader.onload = (event) => selectItem(event.target.result, file.name); reader.readAsDataURL(file); customImageUpload.value = ''; } });
            uploadLogoBtn.addEventListener('click', () => compLogoUpload.click());
            compLogoUpload.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (event) => { logoImageSrc = event.target.result; updateLogoTitleDisplay(); }; reader.readAsDataURL(file); } });
            removeLogoBtn.addEventListener('click', () => { logoImageSrc = null; compLogoUpload.value = ''; updateLogoTitleDisplay(); });
            uploadBackgroundBtn.addEventListener('click', () => backgroundUploadInput.click());
            removeBackgroundBtn.addEventListener('click', () => { backgroundImageSrc = null; backgroundUploadInput.value = ''; applyBackground(); });
            backgroundUploadInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (event) => { backgroundImageSrc = event.target.result; applyBackground(); }; reader.readAsDataURL(file); } });

            saveBtn.addEventListener('click', saveComposition);
            loadBtn.addEventListener('click', () => loadFileInput.click());
            loadFileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) { loadComposition(e.target.files[0]); e.target.value = null; } });

            tabButtonsContainer.addEventListener('click', e => { const clickedTabButton = e.target.closest('.tab-btn'); if (!clickedTabButton) return; tabButtonsContainer.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active')); clickedTabButton.classList.add('active'); document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active')); document.getElementById(clickedTabButton.dataset.tab).classList.add('active'); });
            titleFontSizeSlider.addEventListener('input', (e) => { titleFontSize = e.target.value; titleFontSizeValue.textContent = `${titleFontSize}px`; compTitleInput.style.fontSize = `${titleFontSize}px`; });
            titleColorPicker.addEventListener('input', (e) => { titleColor = e.target.value; compTitleInput.style.color = titleColor; });
            titleAlignGroup.addEventListener('click', (e) => { const button = e.target.closest('button'); if (button && button.dataset.align) { titleAlign = button.dataset.align; compTitleInput.style.textAlign = titleAlign; updateAlignmentButtons(titleAlignGroup, titleAlign); } });
            notesFontSizeSlider.addEventListener('input', (e) => { notesFontSize = e.target.value; notesFontSizeValue.textContent = `${notesFontSize}px`; compNotesInput.style.fontSize = `${notesFontSize}px`; });
            notesColorPicker.addEventListener('input', (e) => { notesColor = e.target.value; compNotesInput.style.color = notesColor; });
            notesAlignGroup.addEventListener('click', (e) => { const button = e.target.closest('button'); if (button && button.dataset.align) { notesAlign = button.dataset.align; compNotesInput.style.textAlign = notesAlign; updateAlignmentButtons(notesAlignGroup, notesAlign); } });
            notesPositionSelect.addEventListener('change', (e) => { notesPosition = e.target.value; });
            enablePartyTableCheck.addEventListener('change', (e) => { isPartyTableEnabled = e.target.checked; partyTableControls.style.display = isPartyTableEnabled ? 'block' : 'none'; });
            addPartyRowBtn.addEventListener('click', addNewPartyTableRow);
            partyTablePositionSelect.addEventListener('change', (e) => { partyTablePosition = e.target.value; });
            partyTableScaleSlider.addEventListener('input', (e) => { partyTableScale = parseFloat(e.target.value); partyTableScaleValue.textContent = `${Math.round(partyTableScale * 100)}%`; });
            partyTableBody.addEventListener('input', (e) => { const input = e.target; const key = input.dataset.key; const index = input.closest('tr').dataset.index; if (key && index && partyTableData[index]) { partyTableData[index][key] = parseInt(input.value) || 0; } });

            // --- FULL EXPORT FUNCTION ---
            exportBtn.addEventListener('click', () => {
                const tempExportContainer = document.createElement('div'); tempExportContainer.id = 'temp-export-wrapper'; document.body.appendChild(tempExportContainer); document.body.classList.add('export-mode');
                if (backgroundImageSrc) { tempExportContainer.style.backgroundImage = `url(${backgroundImageSrc})`; }
                let titleOrLogoClone; if (logoImageSrc) { titleOrLogoClone = document.createElement('img'); titleOrLogoClone.id = 'logo-image-clone'; titleOrLogoClone.src = logoImageSrc; } else { titleOrLogoClone = document.createElement('div'); titleOrLogoClone.id = 'comp-title-clone'; titleOrLogoClone.textContent = compTitleInput.value || compTitleInput.placeholder; titleOrLogoClone.style.fontSize = `${titleFontSize}px`; titleOrLogoClone.style.color = titleColor; titleOrLogoClone.style.textAlign = titleAlign; }
                let notesClone = null; if (compNotesInput.value) { notesClone = document.createElement('div'); notesClone.id = 'comp-notes-clone'; notesClone.textContent = compNotesInput.value; notesClone.style.fontSize = `${notesFontSize}px`; notesClone.style.color = notesColor; notesClone.style.textAlign = notesAlign; }
                let partyTableClone = null; if (isPartyTableEnabled) { partyTableClone = createExportableTableClone(); }
                tempExportContainer.appendChild(titleOrLogoClone); if (partyTablePosition === 'above_full' && partyTableClone) tempExportContainer.appendChild(partyTableClone); if (notesPosition === 'above_full' && notesClone) tempExportContainer.appendChild(notesClone);
                const rolesMainWrapper = document.createElement('div'); rolesMainWrapper.className = 'export-roles-main-wrapper'; const column1 = document.createElement('div'); column1.className = 'export-column-1'; const column2 = document.createElement('div'); column2.className = 'export-column-2';
                if (partyTablePosition === 'col1_top' && partyTableClone) column1.appendChild(partyTableClone); if (notesPosition === 'col1_top' && notesClone) column1.appendChild(notesClone); if (partyTablePosition === 'col2_top' && partyTableClone) column2.appendChild(partyTableClone); if (notesPosition === 'col2_top' && notesClone) column2.appendChild(notesClone);
                Array.from(rolesContainer.querySelectorAll('.role-section')).forEach(roleElement => { const roleId = roleElement.id; const roleElementClone = roleElement.cloneNode(true); if (EXPORT_COLUMN_1_ROLES.includes(roleId)) column1.appendChild(roleElementClone); else if (EXPORT_COLUMN_2_ROLES.includes(roleId)) column2.appendChild(roleElementClone); });
                rolesMainWrapper.appendChild(column1); rolesMainWrapper.appendChild(column2); tempExportContainer.appendChild(rolesMainWrapper);
                if (partyTablePosition === 'below_full' && partyTableClone) tempExportContainer.appendChild(partyTableClone); if (notesPosition === 'below_full' && notesClone) tempExportContainer.appendChild(notesClone);
                html2canvas(tempExportContainer, { scale: 2, useCORS: true, allowTaint: true, backgroundColor: '#1a202c' })
                    .then(canvas => { const link = document.createElement('a'); link.download = `${(compTitleInput.value || 'composition').replace(/[^a-z0-9]/gi, '_').toLowerCase()}.png`; link.href = canvas.toDataURL(); link.click(); })
                    .finally(() => { tempExportContainer.remove(); document.body.classList.remove('export-mode'); });
            });
            
            /* --- START: ADDED FOR SINGLE BUILD EXPORT --- */
            function exportSingleBuild(buildRowElement) {
                // 1. Create temporary container and position off-screen
                const exportWrapper = document.createElement('div');
                exportWrapper.id = 'single-build-export-wrapper';
                document.body.appendChild(exportWrapper);

                // 2. Clone build row and prepare for export by syncing visible values
                const buildClone = buildRowElement.cloneNode(true);
                const quantityInput = buildClone.querySelector('.build-quantity-input');
                const quantityDisplay = buildClone.querySelector('.build-quantity-display');
                if (quantityInput && quantityDisplay) {
                    quantityDisplay.textContent = quantityInput.value || "";
                }
                exportWrapper.appendChild(buildClone);

                // 3. Generate filename from weapon item if possible
                let buildName = 'build';
                try {
                    const weaponImg = buildRowElement.querySelector('.item-slot-wrapper[data-category="weapons"] .primary-item-img');
                    if (weaponImg && weaponImg.alt) {
                        const altText = weaponImg.alt;
                        // Clean up alt text (e.g., remove .png and path components if any)
                        buildName = altText.substring(altText.lastIndexOf('/') + 1).replace('.png', '');
                    }
                } catch (err) { console.warn("Could not generate build name from item.", err); }

                // 4. Use html2canvas to capture the temporary wrapper
                html2canvas(exportWrapper, { 
                    scale: 2, 
                    useCORS: true, 
                    allowTaint: true, 
                    backgroundColor: null // Use wrapper's CSS background color
                })
                .then(canvas => {
                    const link = document.createElement('a');
                    link.download = `albion_build_${buildName.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                    showToast(`Exported build: ${buildName}.png`);
                })
                .finally(() => {
                    // 5. Cleanup temporary elements
                    document.body.removeChild(exportWrapper);
                });
            }
            /* --- END: ADDED FOR SINGLE BUILD EXPORT --- */

            /* ----------------- INITIALIZATION ---------------- */
            function initializeApp() {
                ROLES.forEach(createRoleSection);
                document.querySelectorAll('.role-section').forEach(roleSection => { roleSection.querySelector('.builds-container').appendChild(createBuildRow()); });
                initializePartyTable(); applyCurrentStylesToEditor(); updateLogoTitleDisplay();
            }

            initializeApp();
        });
    </script></body></html>
